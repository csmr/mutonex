name: Mutonex CI

on:
  pull_request:
    branches: [ develop ]

jobs:
  elixir-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Elixir
        uses: erlef/setup-elixir@v1
        with:
          elixir-version: '1.18.4' # Replace with your Elixir version
          otp-version: '28.0.2'   # Replace with your OTP version
      - name: Install dependencies and run tests
        working-directory: ./src/gameserver
        run: |
          mix deps.get
          mix test

  docker-compose-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Build and start services
        run: docker-compose -f src/compose.yaml up -d
      - name: Wait for services to be healthy
        run: |
          echo "Waiting for services to be healthy..."
          timeout 60s bash -c '
            until curl -f http://localhost:8888/health > /dev/null 2>&1 && curl -f http://localhost:4000/health > /dev/null 2>&1; do
              echo "Services not yet healthy. Retrying in 5 seconds..."
              sleep 5
            done
          '
          echo "All services are healthy."
      - name: Check running services
        run: docker-compose -f src/compose.yaml ps
      - name: Check webserver health
        run: curl -f http://localhost:8888/health
      - name: Check gameserver health
        run: curl -f http://localhost:4000/health
